<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chỉnh sửa thông tin - Shopii</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f5f5; color: #222; }
        .container { max-width: 800px; margin: 50px auto; padding: 24px; }
        .account-card { background: #fff; border-radius: 10px; padding: 22px; box-shadow: 0 6px 18px rgba(25, 25, 25, 0.06); }
        .account-card h2 { margin-bottom: 20px; color: #111; font-size: 1.3rem; font-weight: 600; }
        .form-group { margin-bottom: 15px; }
        label { font-weight: 500; margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 14px; border-radius: 8px; border: 1px solid transparent; font-size: .95rem; cursor: pointer; text-decoration: none; }
        .btn-primary { background: linear-gradient(180deg,#0d6efd,#0b5ed7); color: #fff; border-color: rgba(0,0,0,0.03); }
        .btn + .btn { margin-left: 10px; }
    </style>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/fragments :: header}"></div>

<div class="container">
    <div class="account-card">
        <h2>Chỉnh sửa thông tin cá nhân</h2>

        <form th:action="@{/account/edit}" th:object="${user}" method="post">
            <div class="form-group">
                <label>ID người dùng:</label>
                <input type="text" th:field="*{userId}" readonly/>
            </div>

            <div class="form-group">
                <label>Họ và tên:</label>
                <input type="text" th:field="*{fullName}" placeholder="Nhập họ và tên"/>
            </div>

            <div class="form-group">
                <label>Tên đăng nhập:</label>
                <input type="text" th:field="*{username}" placeholder="Nhập tên đăng nhập"/>
            </div>

            <div class="form-group">
                <label>Email:</label>
                <input type="email" th:field="*{email}" placeholder="Nhập email"/>
            </div>

            <div class="form-group">
                <label>Giới tính:</label>
                <select th:field="*{gender}">
                    <option th:value="true" th:selected="${user.gender}">Nam</option>
                    <option th:value="false" th:selected="${!user.gender}">Nữ</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ngày sinh:</label>
                <input type="date" th:field="*{dateOfBirth}" />
            </div>

            <div class="form-group">
                <label>Số điện thoại:</label>
                <input type="text" th:field="*{phone}" placeholder="Nhập số điện thoại"/>
            </div>

            <div class="form-group">
                <label>Địa chỉ:</label>
                <input type="text" th:field="*{address}" placeholder="Nhập địa chỉ"/>
            </div>

            <div class="form-group">
                <label>Vai trò:</label>
                <input type="text" th:field="*{role}" readonly/>
            </div>

            <div class="form-group">
                <label>Provider:</label>
                <input type="text" th:field="*{provider}" readonly/>
            </div>

            <div class="form-group">
                <label>Provider ID:</label>
                <input type="text" th:field="*{providerId}" readonly/>
            </div>

            <div class="form-group">
                <label>Ngày tạo:</label>
                <input type="text" th:value="${#temporals.format(user.createdAt,'dd/MM/yyyy HH:mm:ss')}" readonly/>
            </div>

            <div class="form-group">
                <label>Ngày cập nhật:</label>
                <input type="text" th:value="${#temporals.format(user.updatedAt,'dd/MM/yyyy HH:mm:ss')}" readonly/>
            </div>

            <div>
                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                <a th:href="@{/account}" class="btn btn-primary">Hủy</a>
            </div>
        </form>

    </div>
</div>

<!-- Overlay & panel -->
<div id="cart-overlay" class="hidden"></div>
<div id="cart-panel" class="hidden"></div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("[cart] Ready");

        const overlay = document.getElementById("cart-overlay");
        const panel = document.getElementById("cart-panel");

        // khi click icon giỏ hàng trong header
        document.body.addEventListener("click", function(e) {
            const icon = e.target.closest(".cart-icon-header");
            if (!icon) return;

            e.preventDefault();
            e.stopPropagation();
            console.log("[cart] Icon clicked, loading fragment...");

            fetch("/cart")
                .then(res => res.text())
                .then(html => {
                    panel.innerHTML = html;
                    overlay.classList.remove("hidden");
                    panel.classList.remove("hidden");
                    requestAnimationFrame(() => {
                        overlay.classList.add("show");
                        panel.classList.add("show");
                    });
                })
                .catch(err => console.error("[cart] Lỗi khi load fragment:", err));
        });

        // đóng khi click ra ngoài
        overlay.addEventListener("click", closeCart);

        // đóng khi bấm nút X
        panel.addEventListener("click", e => {
            if (e.target.classList.contains("cart-close-btn") || e.target.classList.contains("close-cart")) {
                closeCart();
            }
        });

        // ESC để đóng
        document.addEventListener("keydown", e => {
            if (e.key === "Escape") closeCart();
        });

        function closeCart() {
            overlay.classList.remove("show");
            panel.classList.remove("show");
            setTimeout(() => {
                overlay.classList.add("hidden");
                panel.classList.add("hidden");
            }, 300);
        }
    });
    // gọi khi trang load
    function updateCartCount() {
        fetch("/cart/count")
            .then(res => res.text())
            .then(count => {
                // cập nhật tất cả các phần tử .cart-count-badge trên trang
                document.querySelectorAll('.cart-count-badge').forEach(el => {
                    // nếu server trả 0 và bạn muốn ẩn badge khi 0
                    if (Number(count) <= 0) {
                        el.classList.add('hidden');  // bạn đã có css .hidden
                        el.textContent = 0;
                    } else {
                        el.classList.remove('hidden');
                        el.textContent = count;
                    }
                });
            })
            .catch(err => console.error('[cart] Không thể lấy count', err));
    }

    // gọi khi DOM sẵn sàng
    document.addEventListener('DOMContentLoaded', function() {
        updateCartCount();
    });
    document.addEventListener("DOMContentLoaded", function() {

        function setupRowPagination(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            function attachPagination() {
                container.querySelectorAll(".grid-pagination button").forEach(btn => {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        const url = this.getAttribute("data-url");
                        if (!url) return;

                        // slide out current
                        container.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                        container.style.transform = 'translateX(-100%)';
                        container.style.opacity = 0;

                        fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
                            .then(res => res.text())
                            .then(html => {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = html;

                                // tìm đúng fragment mới trong response
                                const newSection = tempDiv.querySelector('#' + containerId);
                                if (newSection) {
                                    setTimeout(() => {
                                        container.innerHTML = newSection.innerHTML;

                                        // slide in
                                        container.style.transform = 'translateX(100%)';
                                        container.style.opacity = 0;
                                        requestAnimationFrame(() => {
                                            container.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                                            container.style.transform = 'translateX(0)';
                                            container.style.opacity = 1;
                                        });

                                        // attach listener cho button mới
                                        attachPagination();

                                        // update URL để giữ lịch sử
                                        history.pushState(null, '', url);
                                    }, 300);
                                }
                            })
                            .catch(err => console.error('AJAX pagination error:', err));
                    };
                });
            }

            attachPagination();
        }

        // gọi cho cả 3 row
        setupRowPagination('product-grid-new');
        setupRowPagination('product-grid-sale');
        setupRowPagination('product-grid-hot');

    });
</script>

<footer>
    <div th:replace="~{fragments/fragments :: footer}"></div>
</footer>

<script src="/js/bootstrap.bundle.min.js"></script>
</body>
</html>